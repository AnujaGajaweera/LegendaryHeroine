name: DaVinci Resolve Free (x86_64) (wine)
game_slug: davinci-resolve
version: davinci-resolve-x86_64
slug: davinci-resolve-x86_64
runner: wine

script:
  files:
    - resolve_installer: "N/A:Select DaVinci Resolve Windows installer (.exe)"
    - directml_dll: "N/A:Select directml.dll (x86_64)"

  game:
    exe: $GAMEDIR/drive_c/Program Files/Blackmagic Design/DaVinci Resolve/Resolve.exe
    prefix: $GAMEDIR
    arch: win64
    args: ""

  installer:
    - task:
        name: create_prefix
        prefix: $GAMEDIR
        arch: win64

    - task:
        name: execute
        command: /bin/bash
        args: -lc "clinfo >/dev/null 2>&1 || echo '[WARN] OpenCL not detected in Lutris install context; Resolve GPU compute may fail.'"

    - task:
        name: winetricks
        prefix: $GAMEDIR
        app: win10 vcrun2019

    - copy:
        src: directml_dll
        dst: $GAMEDIR/drive_c/windows/system32/directml.dll

    - task:
        name: wineexec
        prefix: $GAMEDIR
        executable: resolve_installer
        description: Installing DaVinci Resolve Free (x86_64)...

    - write_file:
        file: $GAMEDIR/resolve.reg
        content: |
          REGEDIT4

          [HKEY_CURRENT_USER\Software\Wine\DllOverrides]
          "directml"="native,builtin"
          "nvcuda"="native,builtin"

          [HKEY_CURRENT_USER\Software\Wine\Direct3D]
          "renderer"="vulkan"
          "csmt"="enabled"
          "VideoMemorySize"="0"

          [HKEY_CURRENT_USER\Control Panel\Desktop]
          "LogPixels"=dword:00000060

          [HKEY_CURRENT_USER\Software\Microsoft\Windows NT\CurrentVersion\AppCompatFlags\Layers]
          "C:\\Program Files\\Blackmagic Design\\DaVinci Resolve\\Resolve.exe"="~ HIGHDPIAWARE DISABLEDXMAXIMIZEDWINDOWEDMODE"

          [HKEY_LOCAL_MACHINE\Software\Microsoft\Windows NT\CurrentVersion\Multimedia\SystemProfile]
          "SystemResponsiveness"=dword:0000000a
    - task:
        name: wineexec
        prefix: $GAMEDIR
        executable: regedit
        args: /S $GAMEDIR/resolve.reg

  wine:
    esync: true
    fsync: false
    dxvk: true
    vkd3d: true
    latencyflex: true
    overrides:
      directml: n,b
      nvcuda: n,b

  system:
    env:
      WINEPREFIX: $GAMEDIR
      WINEARCH: win64
      WINEDEBUG: "-all"
      WINEESYNC: "1"
      __GL_THREADED_OPTIMIZATIONS: "1"
      __GL_DISK_CACHE: "1"
      VK_ICD_FILENAMES: "/usr/share/vulkan/icd.d"
      DXVK_LOG_LEVEL: info
      VKD3D_DEBUG: warn
      LATENCYFLEX: "1"
      CUDA_EXPERIMENTAL: "1"
